name: ps-ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  run-script:
    runs-on: windows-latest   # istersen: windows-2022
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force

      - name: Static analysis (fail only on Errors)
        shell: pwsh
        run: |
          $results = Invoke-ScriptAnalyzer -Path ./scripts -Recurse -Severity Error
          $results | Format-Table -AutoSize
          if ($results.Count -gt 0) { Write-Error "ScriptAnalyzer found errors."; exit 1 }

      - name: Run cleanup script (safe WhatIf)
        shell: pwsh
        run: pwsh ./scripts/Clean-TempFiles.ps1 -WhatIf

      - name: Validate Intune configs
        shell: pwsh
        run: pwsh ./scripts/Validate-IntuneConfigs.ps1

      - name: Validate Azure ARM templates
        shell: pwsh
        run: pwsh ./scripts/Validate-AzureArm.ps1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform fmt check
        run: terraform -chdir=./terraform fmt -check -recursive

      - name: Terraform init (no backend)
        run: terraform -chdir=./terraform init -backend=false

      - name: Terraform validate
        run: terraform -chdir=./terraform validate -no-color


      - name: Install Pester
        shell: pwsh
        run: Install-Module Pester -Force -SkipPublisherCheck

      - name: Run Pester tests
        shell: pwsh
        run: |
          Import-Module Pester -Force
          $result = Invoke-Pester -Path ./tests -PassThru -Verbose
          if ($result.FailedCount -gt 0) { exit 1 }
